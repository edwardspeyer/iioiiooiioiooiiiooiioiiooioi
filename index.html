<!doctype html>
<html>
<head>
<meta charset="utf8">
<style>

body {
  background: black;
  font-family: monospace;
  margin: 0;
}

table {
  border-collapse: collapse;
  width: 100vw;
  height: 100vh;
}

td {
  font-size: 3.4em;
  width: 5vw;
  height: 5vh;
  padding: 0;
  text-align: center;
  font-weight: bold;
  overflow: hidden;
}
  
* {
  color: #90ffa7;;
  text-shadow:
    0 0  2px #70ff87,
    0 0 10px #70ff87,
    0 0 20px #70ff87;
}

#display {
  position: relative;
}

#scanlines {
  width: 100%;
  height: 100%;
  background: red;
  position: absolute;
  left: 0;
  top: 0;
  background: repeating-linear-gradient(
    transparent,
    #000 4px,
    transparent 4px
  );
}


</style>
</head>
<body>

<div id="display">
<table>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
<tr><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr>
</table>
<div id="scanlines"/>
</div>

</body>

<script>
const Cells = Array.prototype.slice.call(document.querySelectorAll('td'));
const Height = document.querySelectorAll('tr').length;
const Width = Cells.length / Height;

const Offsets = [
  [-1, -1], [ 0, -1], [ 1, -1],
  [-1,  0], /* hi! */ [ 1,  0],
  [-1,  1], [ 0,  1], [ 1,  1],
]

const Neighbours = {};
for (let x = 0; x < Width; x++) {
  for (let y = 0; y < Height; y++) {
    let i = x + y * Width;
    Neighbours[i] = [];
    for (let dx = -1; dx <= 1; dx++) {
      for (let dy = -1; dy <= 1; dy++) {
        if (dx == 0 && dy == 0) continue;
        let nx = x + dx, ny = y + dy;
        if (nx < 0 || nx >= Width) continue;
        if (ny < 0 || ny >= Height) continue;
        let j = nx + ny * Width;
        Neighbours[i].push(j);
      }
    }
  }
}

function pump(state) {
  return state.map(v => {
    let n = Math.random();
    if (v) {
      return v;
    } else if (n >= 0.75) {
      return 'i';
    } else if (n <= 0.25) {
      return 'o';
    }
  });
}

function render(state) {
  state.forEach((v, i) => {
    Cells[i].innerHTML = v || '&nbsp;';
  });
}

function tick(state) {
  return state.map((v, i) => {
    let neighbours = Neighbours[i].map(j => state[j]);
    let counts = neighbours.reduce((h, v) => {
      h[v] = (h[v] || 0) + 1;
      return h;
    }, {});

    if (v) {
      if (counts[v] >= 2 && counts[v] <= 3) {
        return v;
      } else {
        return null;
      }
    } else {
      if (counts['i'] == 3) {
        return 'i';
      } else if (counts['o'] == 3) {
        return 'o';
      }
    }
  });
}

let state0 = null;
let state1 = null;
let state2 = Cells.map(() => null);
let timeout = 12;

window.setInterval(() => {
  state0 = state1
  state1 = state2;
  state2 = tick(state2);

  if (JSON.stringify(state0) == JSON.stringify(state2)) {
    if (timeout < 12) {
      timeout += 1;
    } else {
      timeout = 0;
      state2 = pump(state2);
    }
  }

  if (state0) {
    render(state0);
  }
}, 1000/12);

</script>

</html>
